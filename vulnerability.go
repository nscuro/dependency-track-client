package dtrack

import (
	"fmt"
	"regexp"
)

const (
	CriticalSeverity   = "CRITICAL"
	HighSeverity       = "HIGH"
	MediumSeverity     = "MEDIUM"
	LowSeverity        = "LOW"
	InfoSeverity       = "INFO"
	UnassignedSeverity = "UNASSIGNED"
)

type VulnerabilitySource string

const (
	NVD           VulnerabilitySource = "NVD"
	OSSIndex      VulnerabilitySource = "OSSIndex"
	UnknownSource VulnerabilitySource = ""
)

var (
	regexCVE  = regexp.MustCompile("^CVE-[\\d]+-[\\d]+$")
	regexUUID = regexp.MustCompile("^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$")
)

type Vulnerability struct {
	UUID     string `json:"uuid"`
	VulnID   string `json:"vulnId"`
	Severity string `json:"severity"`
}

func (c Client) GetVulnerability(uuid string) (*Vulnerability, error) {
	res, err := c.restClient.R().
		SetResult(&Vulnerability{}).
		SetPathParams(map[string]string{
			"uuid": uuid,
		}).
		Get("/api/v1/vulnerability/{uuid}")
	if err != nil {
		return nil, err
	}

	if err = c.checkResponseStatus(res, 200); err != nil {
		return nil, err
	}

	vulnerability, ok := res.Result().(*Vulnerability)
	if !ok {
		return nil, ErrInvalidResponseType
	}

	return vulnerability, nil
}

func (c Client) GetVulnerabilityByVulnID(vulnID string, source VulnerabilitySource) (*Vulnerability, error) {
	if source == UnknownSource {
		return nil, fmt.Errorf("unknown vulnerability source")
	}

	res, err := c.restClient.R().
		SetResult(&Vulnerability{}).
		SetPathParams(map[string]string{
			"source": string(source),
			"vulnId": vulnID,
		}).
		Get("/api/v1/vulnerability/source/{source}/vuln/{vulnId}")
	if err != nil {
		return nil, err
	}

	if err = c.checkResponseStatus(res, 200); err != nil {
		return nil, err
	}

	vulnerability, ok := res.Result().(*Vulnerability)
	if !ok {
		return nil, ErrInvalidResponseType
	}

	return vulnerability, nil
}

func (c Client) GuessVulnerabilitySource(vulnID string) VulnerabilitySource {
	if regexCVE.MatchString(vulnID) {
		return NVD
	} else if regexUUID.MatchString(vulnID) {
		return OSSIndex
	}
	return UnknownSource
}
